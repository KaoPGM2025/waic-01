<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Omni Finance 31.1.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700;800&family=Kanit:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --nexus-primary: #3b82f6;
            --nexus-success: #10b981;
            --nexus-danger: #ef4444;
            --nexus-bg: #020617;
        }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--nexus-bg); color: #f1f5f9; overflow-x: hidden; }
        .font-kanit { font-family: 'Kanit', sans-serif; }
        .nexus-card { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 24px; }
        .nav-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; color: #64748b; font-size: 10px; font-weight: bold; }
        .nav-btn.active { color: var(--nexus-primary); }
        .offline-mode { pointer-events: none; opacity: 0.3; filter: grayscale(1); }
        .switch-input:checked + .slider { background-color: var(--nexus-success); }
        .switch-input:checked + .slider:before { transform: translateX(26px); }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        .goal-progress { transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body class="pb-24">

    <!-- Header & Online Switch -->
    <header class="p-6 flex justify-between items-center bg-slate-900/50 sticky top-0 z-50 backdrop-blur-md border-b border-white/5">
        <div>
            <h1 class="font-black text-lg font-kanit tracking-tight">OMNI <span class="text-blue-500">31.1.0</span></h1>
            <p id="statusIndicator" class="text-[10px] font-bold uppercase tracking-[0.2em] text-emerald-400">System Online</p>
        </div>
        <div class="flex items-center gap-3 bg-slate-800/50 p-2 rounded-full px-4 border border-white/5">
            <span class="text-[10px] font-black opacity-50">SYNC</span>
            <label class="relative inline-block w-12 h-6">
                <input type="checkbox" id="onlineToggle" class="hidden switch-input" checked onchange="toggleSystemState()">
                <span class="slider"></span>
            </label>
        </div>
    </header>

    <main id="mainContainer" class="p-4 max-w-xl mx-auto space-y-6 transition-all duration-300">
        
        <!-- Tab: Dashboard -->
        <div id="tab-dashboard" class="tab-content space-y-6">
            <section class="nexus-card p-8 bg-gradient-to-br from-blue-600/20 to-purple-600/20 border-blue-500/20">
                <p class="text-[10px] font-black uppercase opacity-60 tracking-widest text-center">Total Net Assets</p>
                <h2 id="totalBalance" class="text-4xl font-black font-kanit text-center mt-2">฿0.00</h2>
                <div class="grid grid-cols-2 gap-4 mt-6 pt-6 border-t border-white/10 text-center">
                    <div>
                        <p class="text-[9px] opacity-50 uppercase font-bold">Month In</p>
                        <p id="monthIn" class="text-emerald-400 font-bold font-kanit">฿0.00</p>
                    </div>
                    <div>
                        <p class="text-[9px] opacity-50 uppercase font-bold">Month Out</p>
                        <p id="monthOut" class="text-rose-400 font-bold font-kanit">฿0.00</p>
                    </div>
                </div>
            </section>

            <!-- Form -->
            <section id="formArea" class="nexus-card p-6">
                <form id="financeForm" class="space-y-4">
                    <input type="text" id="title" placeholder="ชื่อรายการ..." required class="w-full bg-slate-900/50 p-4 rounded-2xl border border-white/5 outline-none focus:border-blue-500">
                    <div class="grid grid-cols-2 gap-4">
                        <input type="number" id="amount" placeholder="จำนวนเงิน" step="0.01" required class="w-full bg-slate-900/50 p-4 rounded-2xl border border-white/5 outline-none font-kanit text-blue-400">
                        <select id="type" class="bg-slate-900/50 p-4 rounded-2xl border border-white/5 font-bold">
                            <option value="expense">รายจ่าย</option>
                            <option value="income">รายรับ</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 py-4 rounded-2xl font-black text-xs uppercase tracking-[0.2em] shadow-lg shadow-blue-500/20">บันทึกข้อมูล</button>
                </form>
            </section>

            <!-- Active Logs -->
            <div class="space-y-4">
                <h3 class="px-2 text-[10px] font-black opacity-40 uppercase tracking-widest flex justify-between">
                    Active Logs (48H)
                    <span id="autoPurgeTimer" class="text-blue-500">Auto-Purge Active</span>
                </h3>
                <div id="logList" class="space-y-3"></div>
            </div>
        </div>

        <!-- Tab: Goals -->
        <div id="tab-goals" class="tab-content hidden space-y-6">
            <section class="nexus-card p-6 bg-emerald-500/5 border-emerald-500/10">
                <h3 class="font-black font-kanit mb-4">Financial Goals</h3>
                <div id="goalStatus">
                    <!-- Goal content -->
                </div>
            </section>

            <section class="nexus-card p-6">
                <h4 class="text-xs font-black uppercase opacity-50 mb-4 tracking-widest">ตั้งค่าเป้าหมาย</h4>
                <div class="space-y-4">
                    <input type="text" id="goalTitle" placeholder="เป้าหมาย เช่น ออมซื้อบ้าน" class="w-full bg-slate-900/50 p-4 rounded-xl border border-white/5 outline-none">
                    <input type="number" id="goalTarget" placeholder="จำนวนเงินเป้าหมาย" class="w-full bg-slate-900/50 p-4 rounded-xl border border-white/5 outline-none">
                    <button onclick="updateGoalSettings()" class="w-full bg-emerald-600 py-3 rounded-xl font-bold text-sm">อัปเดตเป้าหมาย</button>
                </div>
            </section>
        </div>

        <!-- Tab: Analytics -->
        <div id="tab-analytics" class="tab-content hidden space-y-6">
            <section class="nexus-card p-6">
                <h3 class="font-black font-kanit mb-6 text-center">การวิเคราะห์พฤติกรรมการใช้จ่าย</h3>
                <div class="w-full max-w-[250px] mx-auto">
                    <canvas id="analyticsChart"></canvas>
                </div>
                <div id="chartLegend" class="mt-6 space-y-2"></div>
            </section>
        </div>

        <!-- Tab: Settings -->
        <div id="tab-settings" class="tab-content hidden space-y-6">
            <section class="nexus-card p-6 border-rose-500/20 bg-rose-500/5">
                <h3 class="font-black font-kanit text-rose-500 mb-2">ล้างข้อมูลทั้งหมด</h3>
                <p class="text-xs opacity-60 mb-6 font-medium">เมื่อยืนยัน ระบบจะทำการลบประวัติ รายรับ-รายจ่าย และเป้าหมายทั้งหมดถาวร ไม่สามารถกู้คืนได้</p>
                <button onclick="confirmNuclearReset()" class="w-full bg-rose-600/20 border border-rose-600 text-rose-500 py-4 rounded-2xl font-black text-xs uppercase tracking-widest">
                    ดำเนินการลบข้อมูลถาวร
                </button>
            </section>
            <div class="text-center opacity-30 py-10">
                <p class="text-[10px] font-black uppercase">System Core Version 31.1.0.812</p>
                <p class="text-[9px]">OMNI-DATA-PROTECTION ENABLED</p>
            </div>
        </div>

    </main>

    <!-- Navigation Bar -->
    <nav class="fixed bottom-0 left-0 right-0 bg-slate-900/90 backdrop-blur-xl border-t border-white/5 flex justify-around p-3 z-50">
        <button onclick="switchTab('dashboard')" class="nav-btn active" id="btn-dashboard">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
            <span>Home</span>
        </button>
        <button onclick="switchTab('goals')" class="nav-btn" id="btn-goals">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
            <span>Goals</span>
        </button>
        <button onclick="switchTab('analytics')" class="nav-btn" id="btn-analytics">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 01-2 2h22a2 2 0 01-2-2v-6a2 2 0 00-2-2h-2a2 2 0 00-2 2v6"></path></svg>
            <span>Stats</span>
        </button>
        <button onclick="switchTab('settings')" class="nav-btn" id="btn-settings">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
            <span>Setup</span>
        </button>
    </nav>

    <!-- Overlay Alerts -->
    <div id="systemAlert" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-6">
        <div class="nexus-card p-8 w-full max-w-sm text-center border-blue-500/50">
            <div id="alertIcon" class="mb-4"></div>
            <h3 id="alertTitle" class="font-black text-xl font-kanit mb-2">Alert</h3>
            <p id="alertMsg" class="text-sm opacity-70 mb-6"></p>
            <div id="alertAction"></div>
        </div>
    </div>

    <script>
        // --- Core Engine 31.1.0 ---
        const DB_KEY = 'finance_zen_supernova_v151'; 
        const GOAL_KEY = 'omni_goal_v311';
        const STATE_KEY = 'omni_state_v311';
        
        let state = {
            transactions: [],
            isOnline: true,
            goal: { title: "เก็บออมทั่วไป", target: 10000, current: 0, completed: false }
        };

        let chart = null;

        const init = () => {
            // Load Legacy Data
            const stored = localStorage.getItem(DB_KEY);
            if (stored) state.transactions = JSON.parse(stored);

            const storedGoal = localStorage.getItem(GOAL_KEY);
            if (storedGoal) state.goal = JSON.parse(storedGoal);

            const storedState = localStorage.getItem(STATE_KEY);
            if (storedState) state.isOnline = JSON.parse(storedState);

            document.getElementById('onlineToggle').checked = state.isOnline;
            
            autoPurge();
            toggleSystemState();
            render();
            initChart();
        };

        const toggleSystemState = () => {
            state.isOnline = document.getElementById('onlineToggle').checked;
            localStorage.setItem(STATE_KEY, JSON.stringify(state.isOnline));
            
            const main = document.getElementById('mainContainer');
            const status = document.getElementById('statusIndicator');
            
            if (!state.isOnline) {
                main.classList.add('offline-mode');
                status.innerText = "System Offline - Read Only";
                status.className = "text-[10px] font-black uppercase tracking-[0.2em] text-rose-500";
            } else {
                main.classList.remove('offline-mode');
                status.innerText = "System Online";
                status.className = "text-[10px] font-black uppercase tracking-[0.2em] text-emerald-400";
            }
        };

        const autoPurge = () => {
            const now = new Date();
            let changed = false;
            state.transactions = state.transactions.map(t => {
                const diff = (now - new Date(t.date)) / (1000 * 60 * 60);
                if (diff >= 48 && !t.isArchived) {
                    changed = true;
                    return { ...t, isArchived: true };
                }
                return t;
            });
            if (changed) save();
        };

        const save = () => {
            localStorage.setItem(DB_KEY, JSON.stringify(state.transactions));
            localStorage.setItem(GOAL_KEY, JSON.stringify(state.goal));
        };

        const switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${tabId}`).classList.add('active');
            
            if(tabId === 'analytics') updateChart();
        };

        const render = () => {
            const fmt = n => new Intl.NumberFormat('th-TH').format(n);
            let bal = 0, mIn = 0, mOut = 0;
            const now = new Date();

            state.transactions.forEach(t => {
                const val = parseFloat(t.amount);
                const isMonth = new Date(t.date).getMonth() === now.getMonth();
                if (t.type === 'income') {
                    bal += val;
                    if (isMonth) mIn += val;
                } else {
                    bal -= val;
                    if (isMonth) mOut += val;
                }
            });

            document.getElementById('totalBalance').innerText = `฿${fmt(bal.toFixed(2))}`;
            document.getElementById('monthIn').innerText = `฿${fmt(mIn.toFixed(2))}`;
            document.getElementById('monthOut').innerText = `฿${fmt(mOut.toFixed(2))}`;

            // Render Logs
            const list = document.getElementById('logList');
            const active = state.transactions.filter(t => !t.isArchived).sort((a,b) => new Date(b.date) - new Date(a.date));
            list.innerHTML = active.map(t => `
                <div class="nexus-card p-4 flex justify-between items-center">
                    <div>
                        <p class="font-bold text-sm">${t.title}</p>
                        <p class="text-[9px] opacity-40 uppercase font-black">${new Date(t.date).toLocaleTimeString('th-TH')}</p>
                    </div>
                    <p class="font-kanit font-bold ${t.type === 'income' ? 'text-emerald-400' : 'text-rose-400'}">
                        ${t.type === 'income' ? '+' : '-'}฿${fmt(t.amount)}
                    </p>
                </div>
            `).join('') || '<div class="text-center py-10 opacity-20 text-xs">No Recent Data</div>';

            renderGoal();
        };

        const renderGoal = () => {
            const goalEl = document.getElementById('goalStatus');
            const percent = Math.min((state.goal.current / state.goal.target) * 100, 100).toFixed(0);
            
            goalEl.innerHTML = `
                <div class="flex justify-between items-end mb-2">
                    <div>
                        <p class="text-[10px] font-black opacity-50 uppercase tracking-widest">${state.goal.title}</p>
                        <p class="font-kanit font-bold text-xl">${percent}%</p>
                    </div>
                    <p class="text-[10px] font-bold opacity-50">฿${state.goal.current} / ฿${state.goal.target}</p>
                </div>
                <div class="w-full h-3 bg-slate-800 rounded-full overflow-hidden">
                    <div class="goal-progress h-full bg-emerald-500" style="width: ${percent}%"></div>
                </div>
            `;

            if (percent >= 100 && !state.goal.completed) {
                state.goal.completed = true;
                handleGoalCompletion();
            }
        };

        const handleGoalCompletion = () => {
            showAlert("Success!", "เป้าหมายสำเร็จแล้ว 100%! ระบบจะลบเป้าหมายนี้ใน 10 วินาที...", "success");
            
            setTimeout(() => {
                // Reset Goal logic
                state.goal = { title: "เป้าหมายใหม่ (Auto)", target: 10000, current: 0, completed: false };
                save();
                showAlert("New Cycle", "เป้าหมายใหม่พร้อมใช้งานแล้ว!", "info");
                setTimeout(() => { 
                    hideAlert(); 
                    render(); 
                }, 3000);
            }, 10000);
        };

        const updateGoalSettings = () => {
            const t = document.getElementById('goalTitle').value;
            const a = document.getElementById('goalTarget').value;
            if(!t || !a) return;
            state.goal.title = t;
            state.goal.target = parseFloat(a);
            state.goal.current = 0;
            state.goal.completed = false;
            save();
            render();
            showAlert("Updated", "ตั้งค่าเป้าหมายใหม่เรียบร้อย", "success");
            setTimeout(hideAlert, 1500);
        };

        const initChart = () => {
            const ctx = document.getElementById('analyticsChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Income', 'Expense', 'Goal Progress'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#10b981', '#ef4444', '#3b82f6'],
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    cutout: '75%',
                    plugins: { legend: { display: false } }
                }
            });
        };

        const updateChart = () => {
            let inc = 0, exp = 0;
            state.transactions.forEach(t => {
                if(t.type === 'income') inc += parseFloat(t.amount);
                else exp += parseFloat(t.amount);
            });
            
            chart.data.datasets[0].data = [inc, exp, state.goal.current];
            chart.update();

            const legend = document.getElementById('chartLegend');
            legend.innerHTML = `
                <div class="flex justify-between items-center text-xs font-bold">
                    <span class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-emerald-500"></div> รายรับสะสม</span>
                    <span>฿${inc.toLocaleString()}</span>
                </div>
                <div class="flex justify-between items-center text-xs font-bold">
                    <span class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-rose-500"></div> รายจ่ายสะสม</span>
                    <span>฿${exp.toLocaleString()}</span>
                </div>
                <div class="flex justify-between items-center text-xs font-bold">
                    <span class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-blue-500"></div> เงินออมเป้าหมาย</span>
                    <span>฿${state.goal.current.toLocaleString()}</span>
                </div>
            `;
        };

        const confirmNuclearReset = () => {
            showAlert("ยืนยันการลบ?", "ข้อมูลทั้งหมดจะหายถาวร ไม่สามารถกู้คืนได้", "danger", true);
        };

        const performNuclearReset = () => {
            localStorage.clear();
            state = {
                transactions: [],
                isOnline: true,
                goal: { title: "เป้าหมายใหม่", target: 10000, current: 0, completed: false }
            };
            save();
            location.reload();
        };

        const showAlert = (title, msg, type, showAction = false) => {
            const alert = document.getElementById('systemAlert');
            const aTitle = document.getElementById('alertTitle');
            const aMsg = document.getElementById('alertMsg');
            const aAction = document.getElementById('alertAction');
            
            aTitle.innerText = title;
            aMsg.innerText = msg;
            
            if(showAction) {
                aAction.innerHTML = `
                    <div class="flex gap-3">
                        <button onclick="hideAlert()" class="flex-1 bg-slate-800 py-3 rounded-xl font-bold">ยกเลิก</button>
                        <button onclick="performNuclearReset()" class="flex-1 bg-rose-600 py-3 rounded-xl font-bold text-white">ยืนยันการลบ</button>
                    </div>
                `;
            } else {
                aAction.innerHTML = `<button onclick="hideAlert()" class="w-full bg-blue-600 py-3 rounded-xl font-bold">ตกลง</button>`;
            }

            alert.classList.remove('hidden');
        };

        const hideAlert = () => document.getElementById('systemAlert').classList.add('hidden');

        document.getElementById('financeForm').onsubmit = (e) => {
            e.preventDefault();
            if(!state.isOnline) return;

            const amt = parseFloat(document.getElementById('amount').value);
            const type = document.getElementById('type').value;

            const newTx = {
                id: Date.now(),
                title: document.getElementById('title').value,
                amount: amt,
                type: type,
                date: new Date().toISOString(),
                isArchived: false
            };

            state.transactions.push(newTx);
            
            // หากเป็นรายรับ จะเติมเข้าเป้าหมายอัตโนมัติ 10% (ตัวอย่าง logic การออม)
            if(type === 'income') {
                state.goal.current += (amt * 0.1); 
            }

            save();
            render();
            e.target.reset();
        };

        window.onload = init;
    </script>
</body>
</html>
