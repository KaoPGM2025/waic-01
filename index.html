<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Nexus v70.0.0 MetaAI 10.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&family=Kanit:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --quantum-cyan: #22d3ee;
            --quantum-purple: #8b5cf6;
            --quantum-bg: #020617;
            --quantum-card: #0f172a;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--quantum-bg);
            color: #e2e8f0;
            font-size: 18px;
            overflow-x: hidden;
        }

        .font-kanit { font-family: 'Kanit', sans-serif; }

        .quantum-card {
            background: linear-gradient(145deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.8));
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 24px;
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
        }

        .ai-pulse-ring {
            position: relative;
        }
        .ai-pulse-ring::after {
            content: "";
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            border: 2px solid var(--quantum-cyan);
            animation: pulse 2s cubic-bezier(0, 0, 0.2, 1) infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        .gradient-text {
            background: linear-gradient(90deg, #22d3ee, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .input-quantum {
            background: rgba(2, 6, 23, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 14px;
            color: white;
            transition: all 0.3s;
        }
        .input-quantum:focus {
            border-color: var(--quantum-cyan);
            outline: none;
            box-shadow: 0 0 15px rgba(34, 211, 238, 0.2);
        }

        .btn-quantum {
            background: linear-gradient(135deg, #06b6d4 0%, #7c3aed 100%);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .btn-quantum:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 10px 25px -5px rgba(6, 182, 212, 0.5);
        }

        .balance-glow {
            text-shadow: 0 0 20px rgba(34, 211, 238, 0.4);
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <!-- Main Header v70 -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-6">
            <div>
                <div class="flex items-center gap-3">
                    <span class="bg-indigo-500/20 text-indigo-400 text-[10px] px-2 py-1 rounded-full font-bold tracking-widest uppercase border border-indigo-500/30">v70.0.0 QUANTUM</span>
                    <span id="syncBadge" class="flex items-center gap-1 text-[10px] text-emerald-400 font-bold opacity-0 transition-opacity duration-1000">
                        <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></span> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
                    </span>
                </div>
                <h1 class="text-5xl font-extrabold font-kanit mt-2 tracking-tight">Finance <span class="gradient-text">Nexus</span></h1>
                <p class="text-slate-500 text-sm mt-1 font-medium">MetaAI 10.0 Powered Financial Core</p>
            </div>
            
            <div class="quantum-card p-6 px-10 border-t-2 border-cyan-500/50 relative overflow-hidden group">
                <div class="absolute -right-4 -top-4 w-20 h-20 bg-cyan-500/10 rounded-full blur-3xl group-hover:bg-cyan-500/20 transition-all"></div>
                <p class="text-[10px] text-slate-400 uppercase tracking-[0.3em] font-bold mb-1">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</p>
                <div id="totalBalance" class="text-4xl font-extrabold font-kanit text-white balance-glow">‡∏ø0.00</div>
            </div>
        </header>

        <!-- MetaAI 10.0 Predictive Analysis -->
        <section class="quantum-card p-6 mb-8 relative overflow-hidden">
            <div class="flex items-center gap-4 mb-4">
                <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-cyan-400 to-purple-600 flex items-center justify-center shadow-lg shadow-cyan-500/20 ai-pulse-ring">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                </div>
                <div>
                    <h2 class="font-bold font-kanit text-xl leading-none">MetaAI 10.0 <span class="text-xs font-normal text-slate-500 ml-2">Quantum Thinking...</span></h2>
                    <p id="aiStatus" class="text-xs text-cyan-400/80 mt-1 font-medium">‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</p>
                </div>
            </div>
            <div id="aiInsight" class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                <div class="text-slate-300 bg-black/20 p-4 rounded-xl border border-white/5">
                    <p id="aiMainText" class="italic">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå...</p>
                </div>
                <div id="aiStats" class="flex gap-4 opacity-0 transition-opacity duration-500">
                    <div class="flex-1 bg-emerald-500/10 p-3 rounded-lg border border-emerald-500/20 text-center">
                        <p class="text-[10px] text-emerald-400 uppercase font-bold">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°</p>
                        <p id="savingRate" class="text-xl font-bold font-kanit text-emerald-500">0%</p>
                    </div>
                    <div class="flex-1 bg-rose-500/10 p-3 rounded-lg border border-rose-500/20 text-center">
                        <p class="text-[10px] text-rose-400 uppercase font-bold">‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
                        <p id="predictionText" class="text-xl font-bold font-kanit text-rose-500">‡∏ø0</p>
                    </div>
                </div>
            </div>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Left: Controls -->
            <div class="lg:col-span-4 space-y-6">
                <!-- Goal Engine -->
                <div class="quantum-card p-6 border-l-4 border-cyan-500">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-kanit font-bold flex items-center gap-2">
                            <span class="w-2 h-2 bg-cyan-500 rounded-full"></span> ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞
                        </h3>
                        <button onclick="openGoalModal()" class="w-8 h-8 flex items-center justify-center rounded-full bg-white/5 hover:bg-white/10 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" /></svg>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div class="flex justify-between items-end">
                            <div>
                                <p id="goalName" class="text-sm font-bold text-slate-400">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏∞‡∏™‡∏°</p>
                                <p id="goalPercentText" class="text-3xl font-black font-kanit gradient-text">0%</p>
                            </div>
                            <div class="text-right">
                                <p class="text-[10px] text-slate-500 font-bold">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡πá‡∏ö</p>
                                <p id="goalRemainingText" class="text-sm font-bold text-white">‡∏ø0</p>
                            </div>
                        </div>
                        <div class="h-3 bg-slate-900 rounded-full overflow-hidden border border-white/5 p-0.5">
                            <div id="goalProgressBar" class="h-full bg-gradient-to-r from-cyan-400 to-indigo-500 rounded-full transition-all duration-1000 shadow-[0_0_10px_rgba(34,211,238,0.5)]" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Input Hub -->
                <div class="quantum-card p-6 shadow-2xl">
                    <h3 class="font-kanit font-bold mb-6 flex items-center gap-2 text-lg">
                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ <span class="text-[10px] bg-white/5 px-2 py-1 rounded">AUTO-SYNC</span>
                    </h3>
                    <form id="financeForm" class="space-y-4">
                        <div class="relative group">
                            <input type="text" id="description" placeholder="‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏°‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ?" class="input-quantum w-full" required>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="relative">
                                <select id="type" class="input-quantum w-full appearance-none">
                                    <option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (+)</option>
                                    <option value="expense" selected>‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (-)</option>
                                </select>
                            </div>
                            <input type="number" id="amount" placeholder="0.00" class="input-quantum w-full" required>
                        </div>
                        <select id="category" class="input-quantum w-full">
                            <option value="‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ">üìÅ ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
                            <option value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£">üç± ‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option>
                            <option value="‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á">üöó ‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</option>
                            <option value="‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å/‡∏ö‡∏¥‡∏•">üè† ‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å/‡∏ö‡∏¥‡∏•‡∏ï‡πà‡∏≤‡∏á‡πÜ</option>
                            <option value="‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á">üõçÔ∏è ‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á/‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á</option>
                            <option value="‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏û‡∏¥‡πÄ‡∏®‡∏©">üí∞ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏û‡∏¥‡πÄ‡∏®‡∏©</option>
                        </select>
                        <button type="submit" class="btn-quantum w-full py-4 rounded-2xl font-black font-kanit text-lg text-white shadow-lg tracking-wider">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á QUANTUM CORE</button>
                    </form>
                </div>
            </div>

            <!-- Right: Data Visualization -->
            <div class="lg:col-span-8 space-y-8">
                <!-- Visual Center -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="quantum-card p-6 min-h-[350px]">
                        <p class="text-[10px] font-black text-slate-500 uppercase mb-4 tracking-[0.2em] flex items-center gap-2">
                            <span class="w-1.5 h-1.5 bg-purple-500 rounded-full"></span> ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢
                        </p>
                        <div class="relative h-64">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                    <div class="quantum-card p-6 min-h-[350px]">
                        <p class="text-[10px] font-black text-slate-500 uppercase mb-4 tracking-[0.2em] flex items-center gap-2">
                            <span class="w-1.5 h-1.5 bg-cyan-500 rounded-full"></span> ‡∏Å‡∏£‡∏≤‡∏ü‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô 12 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                        </p>
                        <div class="relative h-64">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Ephemeral Transaction Feed (v70 Enhanced) -->
                <div class="quantum-card p-6 overflow-hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-kanit font-bold flex items-center gap-2">
                            ‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏ô‡∏¥‡∏£‡∏±‡∏ô‡∏î‡∏£‡πå <span id="sessionCounter" class="text-[10px] bg-cyan-500/20 text-cyan-400 px-2 py-0.5 rounded-full">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                        </h3>
                        <div class="flex items-center gap-2 text-[10px] text-slate-500 font-bold uppercase">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 animate-spin" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏™‡∏π‡∏á: ‡∏ã‡πà‡∏≠‡∏ô‡πÉ‡∏ô 60 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                        </div>
                    </div>
                    <div id="recentActivity" class="space-y-3 max-h-[400px] overflow-y-auto no-scrollbar">
                        <div class="text-center py-12 text-slate-600 italic">‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà Quantum Core...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Goal Setup -->
    <div id="goalModal" class="fixed inset-0 bg-slate-950/95 backdrop-blur-xl hidden items-center justify-center p-6 z-50">
        <div class="quantum-card p-8 w-full max-w-md border-cyan-500/30">
            <h3 class="text-3xl font-black font-kanit mb-2 gradient-text">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</h3>
            <p class="text-slate-400 text-sm mb-6">MetaAI ‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏ä‡∏¥‡∏ï‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ô‡∏µ‡πâ</p>
            <div class="space-y-5">
                <div>
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest">‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?</label>
                    <input type="text" id="goalTitleInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ó‡∏£‡∏¥‡∏õ‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô, ‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì" class="input-quantum w-full mt-2">
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)</label>
                    <input type="number" id="goalAmountInput" placeholder="100000" class="input-quantum w-full mt-2">
                </div>
                <div class="flex gap-3 pt-4">
                    <button onclick="closeGoalModal()" class="flex-1 py-4 rounded-xl font-bold text-slate-500 hover:text-white transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button onclick="saveGoalData()" class="flex-1 btn-quantum py-4 rounded-xl font-black text-white">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CORE ENGINE CONFIG ---
        const DB_KEY = 'finance_nexus_v70_quantum';
        const LEGACY_KEYS = [
            'finance_nexus_v68', 
            'finance_nexus_v66', 
            'meta_finance_v64', 
            'meta_finance_v62'
        ];

        let state = {
            transactions: [],
            goal: { title: "‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß", target: 50000 },
            visibleInSession: [] // {id, expiry}
        };

        let catChart, trendChart;

        // --- 2. DATA MIGRATION & RECOVERY ---
        function initializeQuantumCore() {
            const currentData = localStorage.getItem(DB_KEY);
            
            if (currentData) {
                state = JSON.parse(currentData);
                state.visibleInSession = []; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏¥‡∏ß‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î
            } else {
                // MIGRATION PROTOCOL
                let combinedTxs = [];
                let latestGoal = state.goal;

                LEGACY_KEYS.forEach(key => {
                    const oldRaw = localStorage.getItem(key);
                    if (oldRaw) {
                        try {
                            const oldParsed = JSON.parse(oldRaw);
                            const oldList = oldParsed.transactions || oldParsed.records || [];
                            // ‡∏£‡∏ß‡∏°‡πÅ‡∏ö‡∏ö‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥ (Duplicate Prevention)
                            oldList.forEach(tx => {
                                if (!combinedTxs.find(exist => exist.id === tx.id)) {
                                    combinedTxs.push(tx);
                                }
                            });
                            if (oldParsed.goal && oldParsed.goal.target > latestGoal.target) {
                                latestGoal = oldParsed.goal;
                            }
                        } catch (e) { console.warn('Error migrating', key); }
                    }
                });

                state.transactions = combinedTxs;
                state.goal = latestGoal;
                saveData();
                
                if (combinedTxs.length > 0) {
                    const badge = document.getElementById('syncBadge');
                    badge.style.opacity = '1';
                    setTimeout(() => badge.style.opacity = '0', 5000);
                }
            }
            
            updateUI();
            startSessionLoop();
        }

        function saveData() {
            localStorage.setItem(DB_KEY, JSON.stringify(state));
            updateUI();
        }

        // --- 3. UI & AI LOGIC ---
        function updateUI() {
            const income = state.transactions.filter(t => t.type === 'income').reduce((s, t) => s + Number(t.amount), 0);
            const expense = state.transactions.filter(t => t.type === 'expense').reduce((s, t) => s + Number(t.amount), 0);
            const balance = income - expense;

            // Balance
            document.getElementById('totalBalance').innerText = `‡∏ø${balance.toLocaleString(undefined, {minimumFractionDigits: 2})}`;

            // Goals
            const goalTarget = state.goal.target || 1;
            const pct = Math.min(100, Math.max(0, (balance / goalTarget) * 100));
            document.getElementById('goalName').innerText = state.goal.title;
            document.getElementById('goalPercentText').innerText = `${pct.toFixed(1)}%`;
            document.getElementById('goalProgressBar').style.width = `${pct}%`;
            document.getElementById('goalRemainingText').innerText = `‡∏ø${Math.max(0, goalTarget - balance).toLocaleString()}`;

            // MetaAI Analysis
            runMetaAI(balance, income, expense);
            
            // Visuals
            renderCharts();
            renderSessionList();
        }

        function runMetaAI(net, inc, exp) {
            const aiMain = document.getElementById('aiMainText');
            const aiStats = document.getElementById('aiStats');
            const savingRate = document.getElementById('savingRate');
            const prediction = document.getElementById('predictionText');
            
            if (state.transactions.length === 0) {
                aiMain.innerHTML = "MetaAI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏ï‡∏ô‡∏î‡πå‡∏ö‡∏≤‡∏¢... ‡πÇ‡∏õ‡∏£‡∏î‡∏õ‡πâ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö v68/v66 ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏≤‡∏Å‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö";
                return;
            }

            aiStats.style.opacity = '1';
            const rate = inc > 0 ? ((inc - exp) / inc) * 100 : 0;
            savingRate.innerText = `${rate.toFixed(1)}%`;
            
            // Forecast logic
            const avgExpense = exp / (state.transactions.length || 1);
            const forecast = net - (avgExpense * 5); // ‡∏à‡∏≥‡∏•‡∏≠‡∏á 5 ‡∏ß‡∏±‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
            prediction.innerText = `‡∏ø${forecast.toLocaleString(undefined, {maximumFractionDigits:0})}`;
            prediction.className = `text-xl font-bold font-kanit ${forecast < 0 ? 'text-rose-500' : 'text-emerald-500'}`;

            // Emotional Feedback
            if (rate > 30) {
                aiMain.innerHTML = `<span class="text-emerald-400 font-bold">‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°!</span> ‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå "‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á" MetaAI ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏≠‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏ö‡πÑ‡∏ß‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏´‡∏ô‡∏î 15%`;
            } else if (rate > 0) {
                aiMain.innerHTML = `<span class="text-cyan-400 font-bold">‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢:</span> ‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡∏û‡∏≠‡∏î‡∏µ‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö MetaAI ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡πÅ‡∏£‡∏á‡πÄ‡∏´‡∏ß‡∏µ‡πà‡∏¢‡∏á‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏°‡∏ß‡∏î <span class="text-white">${getTopCategory()}</span> ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢`;
            } else {
                aiMain.innerHTML = `<span class="text-rose-400 font-bold">‡∏™‡∏†‡∏≤‡∏ß‡∏∞‡∏ß‡∏¥‡∏Å‡∏§‡∏ï:</span> ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏∞‡∏™‡∏°‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö ‡∏£‡∏∞‡∏ö‡∏ö Quantum Core ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏±‡∏î‡∏•‡∏î‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ`;
            }
        }

        function getTopCategory() {
            const counts = {};
            state.transactions.filter(t => t.type === 'expense').forEach(t => counts[t.category] = (counts[t.category] || 0) + 1);
            return Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b, '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ');
        }

        // --- 4. TRANSACTION ENGINE ---
        document.getElementById('financeForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = Date.now();
            const newItem = {
                id,
                description: document.getElementById('description').value,
                amount: document.getElementById('amount').value,
                type: document.getElementById('type').value,
                category: document.getElementById('category').value,
                timestamp: id
            };

            state.transactions.push(newItem);
            state.visibleInSession.push({ id: id, expires: id + 60000 });
            
            saveData();
            e.target.reset();
        });

        function renderSessionList() {
            const container = document.getElementById('recentActivity');
            const now = Date.now();
            
            const activeItems = state.transactions.filter(t => {
                const session = state.visibleInSession.find(s => s.id === t.id);
                return session && session.expires > now;
            }).reverse();

            document.getElementById('sessionCounter').innerText = `${activeItems.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

            if (activeItems.length === 0) {
                container.innerHTML = `<div class="text-center py-12 text-slate-600 italic">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ñ‡∏π‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÅ‡∏•‡πâ‡∏ß</div>`;
                return;
            }

            container.innerHTML = activeItems.map(t => {
                const session = state.visibleInSession.find(s => s.id === t.id);
                const timeLeft = Math.ceil((session.expires - now) / 1000);
                return `
                    <div class="flex justify-between items-center p-4 bg-white/5 rounded-2xl border border-white/5 group hover:border-cyan-500/30 transition-all">
                        <div class="flex items-center gap-4">
                            <div class="text-2xl">${getCategoryEmoji(t.category)}</div>
                            <div>
                                <p class="font-bold text-white text-sm">${t.description}</p>
                                <div class="flex items-center gap-2">
                                    <span class="text-[10px] text-slate-500 font-black uppercase">${t.category}</span>
                                    <span class="text-[9px] px-2 py-0.5 bg-rose-500/10 text-rose-400 rounded-full font-bold">HIDE IN ${timeLeft}S</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-kanit font-extrabold ${t.type === 'income' ? 'text-cyan-400' : 'text-rose-400'}">
                                ${t.type === 'income' ? '+' : '-'}‡∏ø${Number(t.amount).toLocaleString()}
                            </p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getCategoryEmoji(cat) {
            const map = { '‡∏≠‡∏≤‡∏´‡∏≤‡∏£': 'üç±', '‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á': 'üöó', '‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å/‡∏ö‡∏¥‡∏•': 'üè†', '‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á': 'üõçÔ∏è', '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏û‡∏¥‡πÄ‡∏®‡∏©': 'üí∞', '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ': 'üìÅ' };
            return map[cat] || 'üíé';
        }

        // --- 5. VISUALIZATION ---
        function renderCharts() {
            const ctxCat = document.getElementById('categoryChart').getContext('2d');
            const ctxTrend = document.getElementById('trendChart').getContext('2d');

            // Category logic
            const expenses = state.transactions.filter(t => t.type === 'expense');
            const cats = {};
            expenses.forEach(e => cats[e.category] = (cats[e.category] || 0) + Number(e.amount));

            if (catChart) catChart.destroy();
            catChart = new Chart(ctxCat, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(cats),
                    datasets: [{
                        data: Object.values(cats),
                        backgroundColor: ['#22d3ee', '#8b5cf6', '#f43f5e', '#fbbf24', '#10b981', '#64748b'],
                        borderWidth: 0,
                        hoverOffset: 20
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8', font: { family: 'Sarabun', size: 10 } } } }
                }
            });

            // Trend Logic
            const last12 = state.transactions.slice(-12);
            let runningBalance = 0;
            const balanceTrend = state.transactions.map(t => {
                runningBalance += (t.type === 'income' ? Number(t.amount) : -Number(t.amount));
                return runningBalance;
            }).slice(-12);

            if (trendChart) trendChart.destroy();
            trendChart = new Chart(ctxTrend, {
                type: 'line',
                data: {
                    labels: balanceTrend.map((_, i) => i + 1),
                    datasets: [{
                        data: balanceTrend,
                        borderColor: '#22d3ee',
                        borderWidth: 4,
                        fill: true,
                        backgroundColor: 'rgba(34, 211, 238, 0.05)',
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        x: { display: false },
                        y: { grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { color: '#475569', font: { size: 9 } } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- 6. UTILITIES ---
        function startSessionLoop() {
            setInterval(() => {
                renderSessionList();
            }, 1000);
        }

        function openGoalModal() {
            document.getElementById('goalModal').classList.remove('hidden');
            document.getElementById('goalModal').classList.add('flex');
            document.getElementById('goalTitleInput').value = state.goal.title;
            document.getElementById('goalAmountInput').value = state.goal.target;
        }

        function closeGoalModal() {
            document.getElementById('goalModal').classList.add('hidden');
            document.getElementById('goalModal').classList.remove('flex');
        }

        function saveGoalData() {
            state.goal.title = document.getElementById('goalTitleInput').value || "‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô";
            state.goal.target = Number(document.getElementById('goalAmountInput').value) || 0;
            saveData();
            closeGoalModal();
        }

        // Start
        initializeQuantumCore();
    </script>
</body>
</html>
