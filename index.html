<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finance Zen 15.6.0 - Chronos Pulse</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700;800&family=Kanit:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --chronos-main: #10b981;
            --chronos-glow: rgba(16, 185, 129, 0.4);
            --bg-dark: #0f172a;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            transition: background 0.3s ease;
        }

        body.dark-mode {
            background-color: var(--bg-dark);
            color: #f1f5f9;
        }

        .chronos-gradient {
            background: linear-gradient(135deg, #10b981 0%, #3b82f6 100%);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 24px;
        }

        .dark-mode .glass-card {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .balance-text {
            text-shadow: 0 4px 12px var(--chronos-glow);
        }

        @keyframes pulse-soft {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        .auto-status {
            animation: pulse-soft 2s infinite;
        }
    </style>
</head>
<body class="pb-32">

    <!-- Header -->
    <header class="p-6 sticky top-0 z-50 backdrop-blur-md border-b border-slate-200 dark:border-slate-800">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 chronos-gradient rounded-full flex items-center justify-center shadow-lg">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <div>
                    <h1 class="text-xl font-black font-kanit">Chronos Pulse</h1>
                    <div class="flex items-center gap-2">
                        <span class="text-[9px] font-bold text-emerald-500 uppercase tracking-tighter">v15.6.0 Stable</span>
                        <span class="w-1 h-1 bg-emerald-500 rounded-full auto-status"></span>
                        <span class="text-[8px] opacity-50 font-bold uppercase">2-Day Auto Cleanup On</span>
                    </div>
                </div>
            </div>
            <button onclick="toggleTheme()" class="p-3 glass-card shadow-sm">
                <span id="themeIcon">‚òÄÔ∏è</span>
            </button>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4 space-y-6">

        <!-- Master Balance -->
        <section class="glass-card p-8 chronos-gradient text-white relative overflow-hidden shadow-2xl">
            <div class="relative z-10 text-center">
                <p class="text-xs font-bold opacity-80 uppercase tracking-[0.2em]">Total Life Assets</p>
                <h2 id="balance" class="text-5xl font-black font-kanit my-6 balance-text">‡∏ø0.00</h2>
                <div class="flex justify-center gap-8 border-t border-white/20 pt-6 mt-4">
                    <div>
                        <p class="text-[10px] font-bold opacity-60 uppercase">In (Month)</p>
                        <p id="monthInc" class="text-lg font-bold font-kanit">‡∏ø0.00</p>
                    </div>
                    <div class="w-[1px] bg-white/10"></div>
                    <div>
                        <p class="text-[10px] font-bold opacity-60 uppercase">Out (Month)</p>
                        <p id="monthExp" class="text-lg font-bold font-kanit">‡∏ø0.00</p>
                    </div>
                </div>
            </div>
            <!-- Decorative Elements -->
            <div class="absolute -bottom-20 -right-20 w-64 h-64 bg-white/10 rounded-full blur-3xl"></div>
        </section>

        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="glass-card p-6">
                <h3 class="text-[10px] font-black opacity-40 uppercase mb-4">Activity Pulse</h3>
                <div class="h-40">
                    <canvas id="pulseChart"></canvas>
                </div>
            </div>
            <div class="glass-card p-6 flex flex-col items-center justify-center text-center">
                <div class="w-16 h-16 bg-emerald-100 dark:bg-emerald-900/30 rounded-full flex items-center justify-center mb-4">
                    <svg class="w-8 h-8 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                </div>
                <h4 class="font-bold font-kanit">Data Integrity Secure</h4>
                <p id="archiveStat" class="text-[10px] opacity-60 mt-1 uppercase font-bold">Scanning for old logs...</p>
            </div>
        </div>

        <!-- Add Entry -->
        <section class="glass-card p-6">
            <form id="txForm" class="grid grid-cols-1 md:grid-cols-12 gap-4">
                <div class="md:col-span-5">
                    <input type="text" id="title" placeholder="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì..." required class="w-full p-4 rounded-2xl bg-slate-100 dark:bg-slate-800 outline-none focus:ring-2 ring-emerald-500 font-medium">
                </div>
                <div class="md:col-span-4">
                    <input type="number" id="amount" placeholder="0.00" step="0.01" required class="w-full p-4 rounded-2xl bg-slate-100 dark:bg-slate-800 outline-none focus:ring-2 ring-emerald-500 font-black text-emerald-600">
                </div>
                <div class="md:col-span-3">
                    <select id="type" class="w-full p-4 rounded-2xl bg-slate-100 dark:bg-slate-800 outline-none focus:ring-2 ring-emerald-500 font-bold">
                        <option value="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
                        <option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
                    </select>
                </div>
                <button type="submit" class="md:col-span-12 py-4 chronos-gradient text-white rounded-2xl font-black text-xs uppercase tracking-widest shadow-lg active:scale-[0.98] transition-transform">
                    Add Transaction
                </button>
            </form>
        </section>

        <!-- Current History -->
        <div class="space-y-4">
            <div class="flex justify-between items-center px-2">
                <h3 class="font-black font-kanit text-lg uppercase">Active Logs (Last 48h)</h3>
                <span class="px-3 py-1 bg-emerald-500/10 text-emerald-500 text-[9px] font-bold rounded-full">AUTO-CLEAN ACTIVE</span>
            </div>
            <div id="historyList" class="space-y-3">
                <!-- Data will be injected here -->
            </div>
        </div>
    </main>

    <!-- Fixed Tools -->
    <div class="fixed bottom-6 left-1/2 -translate-x-1/2 w-max glass-card flex gap-4 px-6 py-3 shadow-2xl z-50">
        <button onclick="exportData()" class="p-2 text-slate-400 hover:text-emerald-500 transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg></button>
        <button onclick="forceSync()" class="p-2 text-slate-400 hover:text-emerald-500 transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg></button>
        <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="p-2 text-slate-400 hover:text-emerald-500 transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg></button>
    </div>

    <script>
        // --- v15.6.0 CHRONOS PULSE CORE ---
        const DB_KEY = 'finance_zen_supernova_v151'; // ‡∏Ñ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢
        const ARCHIVE_HOURS = 48; // ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å‡πÜ 2 ‡∏ß‡∏±‡∏ô

        let state = {
            transactions: [],
            isDark: false
        };

        let chart = null;

        const init = () => {
            // ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î
            state.isDark = localStorage.getItem('chronos_theme') === 'dark';
            document.body.classList.toggle('dark-mode', state.isDark);
            document.getElementById('themeIcon').innerText = state.isDark ? 'üåô' : '‚òÄÔ∏è';

            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            const raw = localStorage.getItem(DB_KEY);
            if (raw) state.transactions = JSON.parse(raw);

            // ‡∏£‡∏±‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            processAutoArchive();
            render();
            
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏Å‡∏´‡∏•‡πà‡∏ô‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤ (Deep Migration)
            setTimeout(deepMigration, 500);
        };

        const processAutoArchive = () => {
            const now = new Date();
            let archivedThisSession = 0;

            state.transactions = state.transactions.map(t => {
                const txDate = new Date(t.date);
                const diffHours = (now - txDate) / (1000 * 60 * 60);

                if (diffHours >= ARCHIVE_HOURS && !t.isArchived) {
                    archivedThisSession++;
                    return { ...t, isArchived: true };
                }
                return t;
            });

            if (archivedThisSession > 0) {
                save();
                console.log(`[Chronos] Archived ${archivedThisSession} transactions older than ${ARCHIVE_HOURS}h`);
            }
            
            const archivedTotal = state.transactions.filter(t => t.isArchived).length;
            document.getElementById('archiveStat').innerText = `Archived: ${archivedTotal} | Active: ${state.transactions.filter(t => !t.isArchived).length}`;
        };

        const deepMigration = () => {
            const OLD_KEYS = ['finance_zen_nebula_v141', 'finance_zen_v151', 'incomes_v313'];
            let count = 0;
            OLD_KEYS.forEach(key => {
                const data = localStorage.getItem(key);
                if (data && key !== DB_KEY) {
                    const parsed = JSON.parse(data);
                    parsed.forEach(oldTx => {
                        const exists = state.transactions.some(t => t.id === oldTx.id);
                        if (!exists) {
                            state.transactions.push({
                                ...oldTx,
                                isArchived: true, // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πà‡∏≤‡∏°‡∏≤‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ archive ‡πÄ‡∏•‡∏¢
                                isMigrated: true
                            });
                            count++;
                        }
                    });
                }
            });
            if (count > 0) {
                save();
                render();
            }
        };

        const save = () => localStorage.setItem(DB_KEY, JSON.stringify(state.transactions));

        const render = () => {
            const list = document.getElementById('historyList');
            let total = 0, mInc = 0, mExp = 0;
            const now = new Date();

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô (‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà archive ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà archive)
            state.transactions.forEach(t => {
                const amt = parseFloat(t.amount);
                const tDate = new Date(t.date);
                const isThisMonth = tDate.getMonth() === now.getMonth() && tDate.getFullYear() === now.getFullYear();

                if (t.type === 'income') {
                    total += amt;
                    if (isThisMonth) mInc += amt;
                } else {
                    total -= amt;
                    if (isThisMonth) mExp += amt;
                }
            });

            const fmt = n => new Intl.NumberFormat('th-TH', { minimumFractionDigits: 2 }).format(n);
            document.getElementById('balance').innerText = `‡∏ø${fmt(total)}`;
            document.getElementById('monthInc').innerText = `‡∏ø${fmt(mInc)}`;
            document.getElementById('monthExp').innerText = `‡∏ø${fmt(mExp)}`;

            // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (Active 48h)
            const activeTx = state.transactions
                .filter(t => !t.isArchived)
                .sort((a,b) => new Date(b.date) - new Date(a.date));

            list.innerHTML = activeTx.map(t => `
                <div class="glass-card p-5 flex justify-between items-center animate-in slide-in-from-top-4 duration-500">
                    <div class="flex items-center gap-4">
                        <div class="w-11 h-11 rounded-2xl flex items-center justify-center font-bold text-lg ${t.type === 'income' ? 'bg-emerald-100 text-emerald-600' : 'bg-rose-100 text-rose-600'}">
                            ${t.type === 'income' ? '+$' : '-$'}
                        </div>
                        <div>
                            <p class="font-bold font-kanit text-sm">${t.title}</p>
                            <span class="text-[9px] font-bold opacity-40 uppercase">${new Date(t.date).toLocaleString('th-TH', {hour12:false})}</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-black font-kanit text-lg ${t.type === 'income' ? 'text-emerald-500' : 'text-rose-500'}">
                            ‡∏ø${fmt(t.amount)}
                        </p>
                    </div>
                </div>
            `).join('') || `
                <div class="text-center py-12 opacity-30">
                    <p class="font-bold text-xs uppercase tracking-widest">No Active Logs</p>
                    <p class="text-[9px] mt-1 italic">Older transactions are safely auto-archived.</p>
                </div>
            `;

            updateChart(activeTx);
        };

        const updateChart = (data) => {
            const ctx = document.getElementById('pulseChart').getContext('2d');
            if (chart) chart.destroy();
            
            const displayData = data.slice(0, 5).reverse();
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: displayData.map(t => t.title.substring(0,5)),
                    datasets: [{
                        data: displayData.map(t => t.type === 'income' ? t.amount : -t.amount),
                        backgroundColor: displayData.map(t => t.type === 'income' ? '#10b981' : '#f43f5e'),
                        borderRadius: 12
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { display: false }, x: { grid: { display: false } } }
                }
            });
        };

        document.getElementById('txForm').onsubmit = (e) => {
            e.preventDefault();
            const newTx = {
                id: 'tx-' + Date.now(),
                title: document.getElementById('title').value,
                amount: parseFloat(document.getElementById('amount').value),
                type: document.getElementById('type').value,
                date: new Date().toISOString(),
                isArchived: false
            };
            
            state.transactions.push(newTx);
            processAutoArchive(); // ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
            save();
            render();
            e.target.reset();
        };

        const toggleTheme = () => {
            state.isDark = !state.isDark;
            document.body.classList.toggle('dark-mode', state.isDark);
            document.getElementById('themeIcon').innerText = state.isDark ? 'üåô' : '‚òÄÔ∏è';
            localStorage.setItem('chronos_theme', state.isDark ? 'dark' : 'light');
        };

        const forceSync = () => {
            processAutoArchive();
            deepMigration();
            render();
        };

        const exportData = () => {
            const dataStr = JSON.stringify(state.transactions);
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Chronos_Pulse_Full_Backup.json`;
            a.click();
        };

        window.onload = init;
    </script>
</body>
</html>
