<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ - Version 3.1.3</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #f1f5f9;
            transition: all 0.3s ease;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        /* Summary Card Interaction */
        .summary-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
            cursor: pointer;
        }
        .summary-card.active-filter {
            border: 2px solid #2563eb;
            background: white;
            box-shadow: 0 0 15px rgba(37, 99, 235, 0.2);
        }
        /* Offline State Styling */
        .system-offline {
            filter: grayscale(0.8);
            pointer-events: none;
            opacity: 0.7;
            user-select: none;
        }
        .status-toggle {
            pointer-events: auto !important;
            filter: none !important;
            opacity: 1 !important;
        }
        .category-badge {
            font-size: 0.65rem;
            padding: 2px 8px;
            border-radius: 9999px;
            font-weight: 600;
        }
        .indicator-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        /* Hide arrows from number input */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header Section -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div class="text-center md:text-left">
                <div class="flex items-center gap-2 justify-center md:justify-start">
                    <h1 class="text-3xl font-bold text-blue-600">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</h1>
                    <span id="saveIndicator" class="text-[10px] bg-blue-100 text-blue-600 px-2 py-1 rounded-full flex items-center gap-1">
                        <span class="w-1.5 h-1.5 bg-blue-600 rounded-full indicator-pulse"></span>
                        ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                    </span>
                </div>
                <p class="text-gray-500 text-sm">Version 3.1.3 ‚Ä¢ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
            </div>
            
            <!-- Status Toggle (Persistence Enabled) -->
            <div class="status-toggle flex items-center bg-white p-3 rounded-2xl shadow-sm border border-gray-100">
                <span id="statusLabel" class="mr-3 font-medium text-green-600 font-semibold">‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="statusCheckbox" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                </label>
            </div>
        </div>

        <div id="mainContent">
            <!-- Interactivity Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div onclick="setTableFilter('today')" id="cardToday" class="glass-card summary-card p-6 rounded-2xl border-l-4 border-green-500">
                    <div class="flex justify-between">
                        <p class="text-sm text-gray-500 mb-1 font-medium">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                        <span class="text-[10px] text-green-500 font-bold tracking-widest">TODAY</span>
                    </div>
                    <h2 id="totalToday" class="text-2xl font-bold text-gray-800">‡∏ø0.00</h2>
                    <p class="text-[10px] text-gray-400 mt-2 italic">* ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                </div>
                <div onclick="setTableFilter('week')" id="cardWeek" class="glass-card summary-card p-6 rounded-2xl border-l-4 border-blue-500">
                    <div class="flex justify-between">
                        <p class="text-sm text-gray-500 mb-1 font-medium">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</p>
                        <span class="text-[10px] text-blue-500 font-bold tracking-widest">WEEK</span>
                    </div>
                    <h2 id="totalWeek" class="text-2xl font-bold text-gray-800">‡∏ø0.00</h2>
                    <p class="text-[10px] text-gray-400 mt-2 italic">* ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</p>
                </div>
                <div onclick="setTableFilter('month')" id="cardMonth" class="glass-card summary-card p-6 rounded-2xl border-l-4 border-purple-500">
                    <div class="flex justify-between">
                        <p class="text-sm text-gray-500 mb-1 font-medium">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</p>
                        <span class="text-[10px] text-purple-500 font-bold tracking-widest">MONTH</span>
                    </div>
                    <h2 id="totalMonth" class="text-2xl font-bold text-gray-800">‡∏ø0.00</h2>
                    <p class="text-[10px] text-gray-400 mt-2 italic">* ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Form: Add Income -->
                <div class="lg:col-span-1">
                    <div class="glass-card p-6 rounded-2xl sticky top-8">
                        <h3 class="text-lg font-semibold mb-4 text-gray-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</h3>
                        <form id="incomeForm" class="space-y-4">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1 uppercase font-bold tracking-wider">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                                <input type="text" id="title" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô, ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡∏ô" 
                                    class="w-full p-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 outline-none transition disabled:bg-gray-100">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1 uppercase font-bold tracking-wider">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
                                    <input type="number" id="amount" required placeholder="0.00" step="0.01"
                                        class="w-full p-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 outline-none transition disabled:bg-gray-100 font-bold text-blue-600">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1 uppercase font-bold tracking-wider">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                                    <select id="category" class="w-full p-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 outline-none transition disabled:bg-gray-100 bg-white cursor-pointer">
                                        <option value="‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ">‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
                                        <option value="‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥">‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥</option>
                                        <option value="‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°">‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°</option>
                                        <option value="‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢">‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢</option>
                                        <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs text-blue-600 mb-1 uppercase font-bold tracking-wider">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</label>
                                <input type="date" id="date" readonly
                                    class="w-full p-3 rounded-xl border border-gray-200 bg-gray-50 text-gray-400 cursor-not-allowed">
                                <p class="text-[10px] text-gray-400 mt-1">* ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πá‡∏≠‡∏Ñ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</p>
                            </div>
                            <button type="submit" id="submitBtn"
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl transition shadow-lg shadow-blue-200 disabled:bg-gray-400 disabled:shadow-none">
                                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                            </button>
                        </form>
                    </div>
                </div>

                <!-- History and Visual Data -->
                <div class="lg:col-span-2 space-y-8">
                    <!-- Chart with Tooltip Upgrade -->
                    <div class="glass-card p-6 rounded-2xl">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-700">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</h3>
                            <span class="text-[10px] text-gray-400">10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
                        </div>
                        <div class="h-64">
                            <canvas id="incomeChart"></canvas>
                        </div>
                    </div>

                    <!-- Filterable Table -->
                    <div class="glass-card rounded-2xl overflow-hidden">
                        <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-white/50">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-700">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h3>
                                <div class="flex items-center gap-2 mt-1">
                                    <p id="filterText" class="text-[10px] text-blue-500 font-bold uppercase tracking-wider">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                                    <span id="activeFilterDot" class="w-1.5 h-1.5 bg-blue-500 rounded-full hidden"></span>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <button onclick="setTableFilter('all')" class="text-[10px] font-bold text-gray-400 hover:text-blue-500 transition uppercase tracking-widest">
                                    [ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á ]
                                </button>
                                <span class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded-full font-bold" id="itemCount">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead>
                                    <tr class="bg-gray-50/80 text-gray-400 text-[10px] uppercase tracking-widest border-b border-gray-100">
                                        <th class="p-4 font-bold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                        <th class="p-4 font-bold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ / ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
                                        <th class="p-4 font-bold text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                                        <th class="p-4 font-bold text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                    </tr>
                                </thead>
                                <tbody id="incomeTableBody" class="text-gray-600"></tbody>
                            </table>
                        </div>
                        <div id="emptyState" class="p-16 text-center">
                            <p class="text-gray-300 font-light text-sm italic">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toastContainer" class="fixed bottom-4 right-4 z-50"></div>

    <script>
        // --- Core Application State ---
        let incomes = JSON.parse(localStorage.getItem('incomes_v313')) || [];
        let chartInstance = null;
        let isOnline = localStorage.getItem('system_status_v313') !== 'offline';
        let currentFilter = 'all';

        // --- DOM Elements ---
        const incomeForm = document.getElementById('incomeForm');
        const incomeTableBody = document.getElementById('incomeTableBody');
        const emptyState = document.getElementById('emptyState');
        const statusCheckbox = document.getElementById('statusCheckbox');
        const statusLabel = document.getElementById('statusLabel');
        const mainContent = document.getElementById('mainContent');
        const saveIndicator = document.getElementById('saveIndicator');
        const formInputs = incomeForm.querySelectorAll('input:not(#date), select, button');

        // --- UI Helper Functions ---

        // Display toast notification
        function showNotif(msg) {
            const toast = document.createElement('div');
            toast.className = 'bg-gray-800 text-white px-6 py-3 rounded-2xl shadow-2xl mb-2 text-sm font-medium transition-all duration-300 transform translate-y-2 opacity-0';
            toast.textContent = msg;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.classList.remove('opacity-0', 'translate-y-2'), 10);
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-2');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Show data saving status
        const notifySave = () => {
            saveIndicator.innerHTML = `<span class="w-1.5 h-1.5 bg-green-500 rounded-full indicator-pulse"></span> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß`;
            saveIndicator.className = 'text-[10px] bg-green-50 text-green-600 px-2 py-1 rounded-full flex items-center gap-1 font-bold';
            setTimeout(() => {
                saveIndicator.innerHTML = `<span class="w-1.5 h-1.5 bg-blue-600 rounded-full indicator-pulse"></span> ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (V3.1.3)`;
                saveIndicator.className = 'text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded-full flex items-center gap-1 font-bold';
            }, 2500);
        }

        // Handle Online/Offline Status (Persistence)
        const setStatusUI = (online, silent = false) => {
            isOnline = online;
            statusCheckbox.checked = online;
            localStorage.setItem('system_status_v313', online ? 'online' : 'offline');

            if (online) {
                statusLabel.textContent = '‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå';
                statusLabel.className = 'mr-3 font-semibold text-green-600';
                mainContent.classList.remove('system-offline');
                formInputs.forEach(el => el.disabled = false);
                if (!silent) showNotif('‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            } else {
                statusLabel.textContent = '‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå';
                statusLabel.className = 'mr-3 font-semibold text-red-500';
                mainContent.classList.add('system-offline');
                formInputs.forEach(el => el.disabled = true);
                if (!silent) showNotif('üîí ‡∏•‡πá‡∏≠‡∏Ñ‡∏£‡∏∞‡∏ö‡∏ö (‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡πÇ‡∏´‡∏°‡∏î)');
            }
        }

        // Format date for inputs (YYYY-MM-DD)
        const setCurrentDate = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            document.getElementById('date').value = `${year}-${month}-${day}`;
        }

        const formatCurrency = (num) => new Intl.NumberFormat('th-TH', { 
            style: 'currency', 
            currency: 'THB',
            minimumFractionDigits: 2 
        }).format(num);

        const getCategoryClass = (cat) => {
            const map = {
                '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ': 'bg-gray-100 text-gray-500',
                '‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥': 'bg-blue-50 text-blue-500',
                '‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°': 'bg-purple-50 text-purple-500',
                '‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢': 'bg-emerald-50 text-emerald-500',
                '‡∏≠‡∏∑‡πà‡∏ô‡πÜ': 'bg-amber-50 text-amber-500'
            };
            return map[cat] || 'bg-gray-100 text-gray-500';
        };

        // --- Core Application Logic ---

        const updateUI = () => {
            localStorage.setItem('incomes_v313', JSON.stringify(incomes));
            renderTable();
            updateSummaries();
            updateChart();
            notifySave();
        };

        // Filter Functionality for Cards
        const setTableFilter = (filterType) => {
            currentFilter = filterType;
            
            // Toggle visual feedback on cards
            document.querySelectorAll('.summary-card').forEach(c => c.classList.remove('active-filter'));
            const filterMap = { 'today': 'cardToday', 'week': 'cardWeek', 'month': 'cardMonth' };
            if(filterMap[filterType]) document.getElementById(filterMap[filterType]).classList.add('active-filter');
            
            // Toggle filter text
            const textMap = { 'all': '‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', 'today': '‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ', 'week': '‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ', 'month': '‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ' };
            document.getElementById('filterText').textContent = textMap[filterType];
            
            // Dot indicator
            const dot = document.getElementById('activeFilterDot');
            filterType === 'all' ? dot.classList.add('hidden') : dot.classList.remove('hidden');

            renderTable();
        };

        const renderTable = () => {
            incomeTableBody.innerHTML = '';
            const now = new Date();
            const todayStr = now.toLocaleDateString('en-CA');
            
            const sun = new Date(now);
            sun.setDate(now.getDate() - now.getDay());
            sun.setHours(0,0,0,0);
            
            const curY = now.getFullYear();
            const curM = now.getMonth();

            let filtered = [...incomes].sort((a,b) => new Date(b.date) - new Date(a.date) || b.id - a.id);

            if (currentFilter === 'today') {
                filtered = filtered.filter(i => i.date === todayStr);
            } else if (currentFilter === 'week') {
                filtered = filtered.filter(i => new Date(i.date) >= sun);
            } else if (currentFilter === 'month') {
                filtered = filtered.filter(i => {
                    const d = new Date(i.date);
                    return d.getFullYear() === curY && d.getMonth() === curM;
                });
            }

            document.getElementById('itemCount').textContent = `${filtered.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

            if (filtered.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                filtered.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-50 hover:bg-gray-50/50 transition-all group';
                    row.innerHTML = `
                        <td class="p-4 text-[11px] font-bold text-gray-400">${new Date(item.date).toLocaleDateString('th-TH')}</td>
                        <td class="p-4">
                            <div class="text-sm font-semibold text-gray-800">${item.title}</div>
                            <span class="category-badge ${getCategoryClass(item.category)}">${item.category}</span>
                        </td>
                        <td class="p-4 text-right font-bold text-blue-600">${formatCurrency(item.amount)}</td>
                        <td class="p-4 text-center">
                            <button onclick="deleteItem('${item.id}')" class="p-2 text-gray-300 hover:text-red-500 hover:bg-red-50 rounded-xl transition-all opacity-0 group-hover:opacity-100">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </td>
                    `;
                    incomeTableBody.appendChild(row);
                });
            }
        };

        const updateSummaries = () => {
            const now = new Date();
            const todayStr = now.toLocaleDateString('en-CA');
            const sun = new Date(now);
            sun.setDate(now.getDate() - now.getDay());
            sun.setHours(0,0,0,0);
            
            let t = 0, w = 0, m = 0;
            incomes.forEach(i => {
                const iDate = new Date(i.date);
                if (i.date === todayStr) t += i.amount;
                if (iDate >= sun && iDate <= now) w += i.amount;
                if (iDate.getFullYear() === now.getFullYear() && iDate.getMonth() === now.getMonth()) m += i.amount;
            });

            document.getElementById('totalToday').textContent = formatCurrency(t);
            document.getElementById('totalWeek').textContent = formatCurrency(w);
            document.getElementById('totalMonth').textContent = formatCurrency(m);
        };

        const updateChart = () => {
            const ctx = document.getElementById('incomeChart').getContext('2d');
            const dailyData = {};
            incomes.forEach(i => dailyData[i.date] = (dailyData[i.date] || 0) + i.amount);

            const sortedKeys = Object.keys(dailyData).sort((a,b) => new Date(a) - new Date(b)).slice(-10);
            const labels = sortedKeys.map(d => new Date(d).toLocaleDateString('th-TH', {day:'numeric', month:'short'}));
            const values = sortedKeys.map(d => dailyData[d]);

            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ',
                        data: values,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.05)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 4,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#2563eb',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 9
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#0f172a',
                            titleFont: { family: 'Kanit', size: 12 },
                            bodyFont: { family: 'Kanit', size: 16, weight: 'bold' },
                            padding: 14,
                            cornerRadius: 12,
                            displayColors: false,
                            callbacks: { label: (c) => `‡∏ø${c.parsed.y.toLocaleString()}` }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { borderDash: [5, 5] }, ticks: { font: { family: 'Kanit', size: 10 } } },
                        x: { grid: { display: false }, ticks: { font: { family: 'Kanit', size: 10 } } }
                    }
                }
            });
        };

        // --- Listeners ---

        statusCheckbox.addEventListener('change', (e) => setStatusUI(e.target.checked));

        incomeForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (!isOnline) return;

            const entry = {
                id: Date.now().toString(),
                title: document.getElementById('title').value,
                amount: parseFloat(document.getElementById('amount').value),
                category: document.getElementById('category').value,
                date: document.getElementById('date').value
            };

            incomes.push(entry);
            incomeForm.reset();
            setCurrentDate();
            updateUI();
            showNotif('üí∞ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
        });

        window.deleteItem = (id) => {
            if (!isOnline) { showNotif('‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πá‡∏≠‡∏Ñ‡∏≠‡∏¢‡∏π‡πà ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ'); return; }
            incomes = incomes.filter(i => i.id !== id);
            updateUI();
            showNotif('üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        };

        // Every 60s, re-check time for Daily Reset and refresh date field
        setInterval(() => {
            updateSummaries();
            setCurrentDate();
        }, 60000);

        // Initial Start
        setStatusUI(isOnline, true);
        setCurrentDate();
        updateUI();
    </script>
</body>
</html>
