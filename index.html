<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ - Version 3.1.4</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #f8fafc;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .summary-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            cursor: pointer;
        }
        .summary-card.active-filter {
            border: 2px solid #2563eb;
            background: white;
        }
        .system-offline {
            filter: grayscale(0.8);
            pointer-events: none;
            opacity: 0.7;
        }
        .status-toggle {
            pointer-events: auto !important;
            filter: none !important;
            opacity: 1 !important;
        }
        .category-badge {
            font-size: 0.65rem;
            padding: 2px 10px;
            border-radius: 9999px;
            font-weight: 600;
        }
        .indicator-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div>
                <div class="flex items-center gap-2 justify-center md:justify-start">
                    <h1 class="text-3xl font-bold text-slate-800">Income <span class="text-blue-600">Tracker</span></h1>
                    <span id="saveIndicator" class="text-[10px] bg-blue-50 text-blue-600 px-3 py-1 rounded-full flex items-center gap-1 font-semibold border border-blue-100">
                        <span class="w-1.5 h-1.5 bg-blue-600 rounded-full indicator-pulse"></span>
                        V3.1.4 ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
                    </span>
                </div>
                <p class="text-gray-500 text-sm mt-1">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
            </div>
            
            <!-- Online/Offline Switch -->
            <div class="status-toggle flex items-center bg-white p-2.5 rounded-xl shadow-sm border border-slate-200">
                <span id="statusLabel" class="mr-3 text-xs font-bold text-green-600 uppercase">Online</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="statusCheckbox" class="sr-only peer">
                    <div class="w-10 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-600"></div>
                </label>
            </div>
        </div>

        <div id="mainContent">
            <!-- Summary Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div onclick="setTableFilter('today')" id="cardToday" class="glass-card summary-card p-6 rounded-2xl border-b-4 border-emerald-500">
                    <p class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                    <h2 id="totalToday" class="text-2xl font-bold text-slate-800">‡∏ø0.00</h2>
                </div>
                <div onclick="setTableFilter('week')" id="cardWeek" class="glass-card summary-card p-6 rounded-2xl border-b-4 border-blue-500">
                    <p class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</p>
                    <h2 id="totalWeek" class="text-2xl font-bold text-slate-800">‡∏ø0.00</h2>
                </div>
                <div onclick="setTableFilter('month')" id="cardMonth" class="glass-card summary-card p-6 rounded-2xl border-b-4 border-indigo-500">
                    <p class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</p>
                    <h2 id="totalMonth" class="text-2xl font-bold text-slate-800">‡∏ø0.00</h2>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- Sidebar: Form & Category Chart -->
                <div class="lg:col-span-4 space-y-6">
                    <!-- Form -->
                    <div class="glass-card p-6 rounded-2xl">
                        <h3 class="text-md font-bold mb-5 text-slate-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</h3>
                        <form id="incomeForm" class="space-y-4">
                            <div>
                                <label class="block text-[10px] text-slate-400 mb-1 uppercase font-bold tracking-widest">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                                <input type="text" id="title" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" class="w-full p-3 rounded-xl border border-slate-200 outline-none text-sm">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-[10px] text-slate-400 mb-1 uppercase font-bold tracking-widest">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
                                    <input type="number" id="amount" required placeholder="0.00" step="0.01" class="w-full p-3 rounded-xl border border-slate-200 outline-none text-sm font-bold text-blue-600">
                                </div>
                                <div>
                                    <label class="block text-[10px] text-slate-400 mb-1 uppercase font-bold tracking-widest">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                                    <select id="category" class="w-full p-3 rounded-xl border border-slate-200 outline-none text-sm bg-white">
                                        <option value="‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ">‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
                                        <option value="‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥">‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥</option>
                                        <option value="‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°">‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°</option>
                                        <option value="‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢">‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢</option>
                                        <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                                    </select>
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl transition shadow-lg mt-2 text-sm uppercase">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                        </form>
                    </div>

                    <!-- Category Chart (Analytics) -->
                    <div class="glass-card p-6 rounded-2xl">
                        <h3 class="text-sm font-bold mb-4 text-slate-700">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h3>
                        <div class="h-48">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Main Area: History & Search -->
                <div class="lg:col-span-8 space-y-6">
                    <div class="glass-card p-6 rounded-2xl">
                        <h3 class="text-sm font-bold text-slate-700 mb-6">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</h3>
                        <div class="h-64">
                            <canvas id="incomeChart"></canvas>
                        </div>
                    </div>

                    <!-- Table with Search -->
                    <div class="glass-card rounded-2xl overflow-hidden border border-slate-100">
                        <div class="p-4 border-b border-slate-100 bg-white flex flex-col sm:flex-row justify-between items-center gap-4">
                            <div class="relative w-full sm:w-64">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                                </span>
                                <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£..." class="w-full pl-9 pr-4 py-2 bg-slate-50 border-none rounded-xl text-xs outline-none focus:ring-2 focus:ring-blue-100">
                            </div>
                            <div class="flex items-center gap-4">
                                <span id="filterLabel" class="text-[10px] font-bold text-blue-500 bg-blue-50 px-2 py-1 rounded uppercase">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                                <span class="text-xs font-bold text-slate-400" id="itemCount">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-slate-50 text-slate-400 text-[10px] uppercase tracking-widest">
                                    <tr>
                                        <th class="p-4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                        <th class="p-4 text-center">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
                                        <th class="p-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                        <th class="p-4 text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                                        <th class="p-4"></th>
                                    </tr>
                                </thead>
                                <tbody id="incomeTableBody" class="text-sm"></tbody>
                            </table>
                        </div>
                        <div id="emptyState" class="p-12 text-center hidden">
                            <p class="text-slate-300 italic text-sm">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toastContainer" class="fixed bottom-4 right-4 z-50"></div>

    <script>
        // --- 3.1.4 Data Preservation Layer ---
        const STORAGE_KEY = 'incomes_v313'; // ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢
        let incomes = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        
        let chartInstance = null;
        let categoryChartInstance = null;
        let isOnline = localStorage.getItem('system_status_v313') !== 'offline';
        let currentFilter = 'all';
        let searchQuery = '';

        const incomeForm = document.getElementById('incomeForm');
        const incomeTableBody = document.getElementById('incomeTableBody');
        const searchInput = document.getElementById('searchInput');

        function showNotif(msg) {
            const toast = document.createElement('div');
            toast.className = 'bg-slate-800 text-white px-5 py-2.5 rounded-xl shadow-lg mb-2 text-xs font-bold transition-all';
            toast.textContent = msg;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        const formatCurrency = (num) => new Intl.NumberFormat('th-TH', { 
            style: 'currency', currency: 'THB' 
        }).format(num);

        const getCategoryClass = (cat) => {
            const colors = {
                '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ': 'bg-slate-100 text-slate-500',
                '‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥': 'bg-blue-100 text-blue-600',
                '‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°': 'bg-indigo-100 text-indigo-600',
                '‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢': 'bg-emerald-100 text-emerald-600',
                '‡∏≠‡∏∑‡πà‡∏ô‡πÜ': 'bg-amber-100 text-amber-600'
            };
            return colors[cat] || colors['‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'];
        };

        const updateUI = () => {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(incomes));
            renderTable();
            updateSummaries();
            updateCharts();
        };

        const renderTable = () => {
            incomeTableBody.innerHTML = '';
            const now = new Date();
            const todayStr = now.toLocaleDateString('en-CA');
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - now.getDay());
            startOfWeek.setHours(0,0,0,0);

            let filtered = incomes.filter(item => {
                let matchesTime = true;
                if(currentFilter === 'today') matchesTime = item.date === todayStr;
                else if(currentFilter === 'week') matchesTime = new Date(item.date) >= startOfWeek;
                else if(currentFilter === 'month') {
                    const d = new Date(item.date);
                    matchesTime = d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth();
                }

                const matchesSearch = item.title.toLowerCase().includes(searchQuery.toLowerCase()) || 
                                     item.category.toLowerCase().includes(searchQuery.toLowerCase());
                
                return matchesTime && matchesSearch;
            });

            filtered.sort((a,b) => new Date(b.date) - new Date(a.date) || b.id - a.id);
            document.getElementById('itemCount').textContent = `${filtered.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

            if (filtered.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
            } else {
                document.getElementById('emptyState').classList.add('hidden');
                filtered.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-slate-50 hover:bg-slate-50 transition-all group';
                    row.innerHTML = `
                        <td class="p-4 text-[10px] font-bold text-slate-400">${new Date(item.date).toLocaleDateString('th-TH')}</td>
                        <td class="p-4 text-center"><span class="category-badge ${getCategoryClass(item.category)}">${item.category}</span></td>
                        <td class="p-4 font-semibold text-slate-700">${item.title}</td>
                        <td class="p-4 text-right font-bold text-slate-800">${formatCurrency(item.amount)}</td>
                        <td class="p-4 text-center">
                            <button onclick="deleteItem('${item.id}')" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </td>
                    `;
                    incomeTableBody.appendChild(row);
                });
            }
        };

        const updateSummaries = () => {
            const now = new Date();
            const todayStr = now.toLocaleDateString('en-CA');
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - now.getDay());

            let t = 0, w = 0, m = 0;
            incomes.forEach(i => {
                const iDate = new Date(i.date);
                if(i.date === todayStr) t += i.amount;
                if(iDate >= startOfWeek && iDate <= now) w += i.amount;
                if(iDate.getFullYear() === now.getFullYear() && iDate.getMonth() === now.getMonth()) m += i.amount;
            });

            document.getElementById('totalToday').textContent = formatCurrency(t);
            document.getElementById('totalWeek').textContent = formatCurrency(w);
            document.getElementById('totalMonth').textContent = formatCurrency(m);
        };

        const updateCharts = () => {
            // Line Chart
            const ctxLine = document.getElementById('incomeChart').getContext('2d');
            const daily = {};
            incomes.forEach(i => daily[i.date] = (daily[i.date] || 0) + i.amount);
            const sortedKeys = Object.keys(daily).sort((a,b) => new Date(a) - new Date(b)).slice(-10);

            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctxLine, {
                type: 'line',
                data: {
                    labels: sortedKeys.map(d => new Date(d).toLocaleDateString('th-TH', {day:'numeric', month:'short'})),
                    datasets: [{
                        data: sortedKeys.map(d => daily[d]),
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.05)',
                        fill: true, tension: 0.4, borderWidth: 3
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            // Doughnut Chart (New)
            const ctxPie = document.getElementById('categoryChart').getContext('2d');
            const cats = {};
            incomes.forEach(i => cats[i.category] = (cats[i.category] || 0) + i.amount);

            if (categoryChartInstance) categoryChartInstance.destroy();
            categoryChartInstance = new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(cats),
                    datasets: [{
                        data: Object.values(cats),
                        backgroundColor: ['#cbd5e1', '#2563eb', '#6366f1', '#10b981', '#f59e0b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, cutout: '70%',
                    plugins: { legend: { position: 'bottom', labels: { font: { family: 'Kanit', size: 10 } } } }
                }
            });
        };

        window.setTableFilter = (f) => {
            currentFilter = f;
            document.querySelectorAll('.summary-card').forEach(c => c.classList.remove('active-filter'));
            const map = { 'today': 'cardToday', 'week': 'cardWeek', 'month': 'cardMonth' };
            if(map[f]) document.getElementById(map[f]).classList.add('active-filter');
            document.getElementById('filterLabel').textContent = f === 'all' ? '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : (f === 'today' ? '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ' : (f === 'week' ? '‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ' : '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ'));
            renderTable();
        };

        const setStatusUI = (online) => {
            isOnline = online;
            document.getElementById('statusCheckbox').checked = online;
            localStorage.setItem('system_status_v313', online ? 'online' : 'offline');
            const label = document.getElementById('statusLabel');
            label.textContent = online ? 'Online' : 'Offline';
            label.className = online ? 'mr-3 text-xs font-bold text-green-600 uppercase' : 'mr-3 text-xs font-bold text-red-500 uppercase';
            document.getElementById('mainContent').classList.toggle('system-offline', !online);
        };

        searchInput.addEventListener('input', (e) => { searchQuery = e.target.value; renderTable(); });
        document.getElementById('statusCheckbox').addEventListener('change', (e) => setStatusUI(e.target.checked));

        incomeForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if(!isOnline) return;
            const entry = {
                id: Date.now().toString(),
                title: document.getElementById('title').value,
                amount: parseFloat(document.getElementById('amount').value),
                category: document.getElementById('category').value,
                date: new Date().toLocaleDateString('en-CA')
            };
            incomes.push(entry);
            incomeForm.reset();
            updateUI();
            showNotif('üí∞ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        });

        window.deleteItem = (id) => {
            if(!isOnline) return;
            incomes = incomes.filter(i => i.id !== id);
            updateUI();
            showNotif('üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß');
        };

        setStatusUI(isOnline);
        updateUI();
    </script>
</body>
</html>
