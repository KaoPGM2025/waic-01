<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finance Nexus 43.0.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700;800&family=Kanit:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --nexus-primary: #8b5cf6;
            --nexus-success: #10b981;
            --nexus-danger: #ef4444;
            --nexus-bg: #030712;
        }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--nexus-bg); color: #f1f5f9; min-height: 100vh; overflow-x: hidden; }
        .font-kanit { font-family: 'Kanit', sans-serif; }
        .nexus-card { background: rgba(17, 24, 39, 0.7); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 28px; }
        .glass-input { background: rgba(0, 0, 0, 0.2); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 12px 16px; width: 100%; transition: all 0.3s; }
        .glass-input:focus { border-color: var(--nexus-primary); outline: none; box-shadow: 0 0 15px rgba(139, 92, 246, 0.2); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .entry-anim { animation: slideIn 0.4s ease-out forwards; }
    </style>
</head>
<body class="p-4 md:p-6 lg:p-10">

    <!-- Header Section -->
    <header class="max-w-4xl mx-auto flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
        <div>
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-indigo-600 rounded-2xl flex items-center justify-center shadow-lg shadow-indigo-500/30">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                </div>
                <div>
                    <h1 class="text-2xl font-black tracking-tight font-kanit">NEXUS <span class="text-indigo-500">43.0.0</span></h1>
                    <p class="text-[10px] uppercase tracking-[0.2em] text-slate-500 font-bold">Neural Pulse Interface</p>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-6">
            <div class="text-right">
                <p class="text-[10px] font-black text-slate-500 uppercase">System Status</p>
                <div class="flex items-center gap-2 justify-end">
                    <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                    <span class="text-xs font-bold text-emerald-500 uppercase">Secured</span>
                </div>
            </div>
            <button onclick="toggleSettings()" class="w-12 h-12 nexus-card flex items-center justify-center hover:bg-slate-800 transition-all">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
            </button>
        </div>
    </header>

    <main class="max-w-4xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <!-- Left Column: Balance & Stats -->
        <div class="lg:col-span-7 space-y-6">
            <!-- Main Balance Card -->
            <section class="nexus-card p-8 bg-gradient-to-br from-indigo-600/10 to-transparent border-indigo-500/20 relative overflow-hidden">
                <div class="relative z-10">
                    <p class="text-[11px] font-bold text-indigo-400 uppercase tracking-widest mb-2">Total Combined Liquidity</p>
                    <div class="flex items-baseline gap-2">
                        <span class="text-2xl font-light text-slate-500 font-kanit">‡∏ø</span>
                        <h2 id="totalBalance" class="text-5xl font-black font-kanit tracking-tighter">0.00</h2>
                    </div>
                    <div class="mt-6 flex gap-4">
                        <div class="px-3 py-1 bg-emerald-500/10 border border-emerald-500/20 rounded-full">
                            <p class="text-[9px] font-bold text-emerald-500 uppercase">Vault Balance: <span id="vaultText">0</span></p>
                        </div>
                        <div class="px-3 py-1 bg-amber-500/10 border border-amber-500/20 rounded-full">
                            <p class="text-[9px] font-bold text-amber-500 uppercase italic">Safe Exit: 10% Reserved</p>
                        </div>
                    </div>
                </div>
                <!-- Abstract BG Decor -->
                <div class="absolute -right-10 -bottom-10 w-40 h-40 bg-indigo-500/10 rounded-full blur-3xl"></div>
            </section>

            <!-- Chart Section -->
            <section class="nexus-card p-6">
                <h3 class="text-sm font-bold font-kanit mb-4 flex items-center gap-2">
                    <span class="w-1.5 h-4 bg-indigo-500 rounded-full"></span>
                    Spending DNA Analysis
                </h3>
                <div class="h-64 flex items-center justify-center">
                    <canvas id="dnaChart"></canvas>
                </div>
            </section>

            <!-- Goal Tracker (Integrated) -->
            <section id="goalSection" class="nexus-card p-6 border-amber-500/20 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-bold text-amber-500 uppercase tracking-wider">Mission Goal</h3>
                    <span id="goalPercent" class="text-lg font-black text-amber-500">0%</span>
                </div>
                <p id="goalName" class="text-xl font-bold font-kanit mb-2 text-white">---</p>
                <div class="h-2 bg-slate-800 rounded-full overflow-hidden">
                    <div id="goalProgress" class="h-full bg-gradient-to-r from-amber-600 to-yellow-300 transition-all duration-1000" style="width: 0%"></div>
                </div>
                <div class="flex justify-between mt-3 text-[10px] font-bold text-slate-500">
                    <span id="goalCurrent">‡∏ø0</span>
                    <span id="goalTarget">‡∏ø0</span>
                </div>
            </section>
        </div>

        <!-- Right Column: Form & History -->
        <div class="lg:col-span-5 space-y-6">
            <!-- Record Form -->
            <section class="nexus-card p-6">
                <h3 class="text-xs font-black uppercase text-slate-400 mb-4 tracking-widest">New Entry</h3>
                <form id="txForm" class="space-y-4">
                    <input type="text" id="txLabel" placeholder="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì..." required class="glass-input text-sm">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="number" id="txAmount" placeholder="0.00" step="0.01" required class="glass-input font-black">
                        <select id="txType" class="glass-input font-bold text-xs appearance-none">
                            <option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (+)</option>
                            <option value="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (-)</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white p-4 rounded-2xl font-black text-xs uppercase tracking-widest transition-all shadow-lg shadow-indigo-500/20 active:scale-95">Pulse Record</button>
                </form>
            </section>

            <!-- Rolling History -->
            <div class="flex justify-between items-center px-2">
                <h3 class="text-[10px] font-black uppercase text-slate-500 tracking-widest">Temporal Stream</h3>
                <span class="text-[9px] font-bold px-2 py-0.5 bg-slate-800 rounded-full text-slate-400 uppercase">Last 48 Hours</span>
            </div>
            <div id="historyStream" class="space-y-3 max-h-[400px] overflow-y-auto pr-2">
                <!-- Data injected here -->
            </div>
        </div>
    </main>

    <!-- Settings Overlay -->
    <div id="settingsOverlay" class="fixed inset-0 bg-slate-950/90 backdrop-blur-xl z-[100] hidden items-center justify-center p-6">
        <div class="nexus-card p-8 w-full max-w-md border-indigo-500/20">
            <h3 class="text-xl font-black font-kanit text-indigo-400 mb-6 text-center">Settings & Control</h3>
            
            <div class="space-y-4">
                <button onclick="openGoalSetup()" class="w-full p-4 bg-amber-500/10 border border-amber-500/20 rounded-2xl flex items-center justify-between group hover:bg-amber-500 hover:text-slate-950 transition-all">
                    <span class="text-xs font-black uppercase tracking-widest">Configure Mission Goal</span>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>
                </button>

                <div class="p-4 bg-slate-800/40 rounded-2xl border border-white/5">
                    <div class="flex justify-between items-center mb-2">
                        <p class="text-[10px] font-black uppercase text-slate-500">Auto-Purge (48H Cycle)</p>
                        <span class="text-[10px] font-bold text-emerald-500 uppercase">Active</span>
                    </div>
                    <p class="text-[10px] text-slate-400 leading-relaxed italic">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡∏ß‡πà‡∏≤ 2 ‡∏ß‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÇ‡∏î‡∏¢‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏∞‡∏™‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà "Vault Balance" ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏≤‡∏ß‡∏£</p>
                </div>

                <div class="pt-6 border-t border-white/5">
                    <button onclick="confirmReset()" class="w-full p-4 bg-rose-500/10 text-rose-500 border border-rose-500/20 rounded-2xl text-[10px] font-black uppercase hover:bg-rose-600 hover:text-white transition-all">Destroy All Data (Factory Reset)</button>
                </div>

                <button onclick="toggleSettings()" class="w-full text-center text-xs font-bold text-slate-500 py-4 uppercase">Return to Interface</button>
            </div>
        </div>
    </div>

    <!-- Goal Setup Modal -->
    <div id="goalModal" class="fixed inset-0 bg-black/80 backdrop-blur-md z-[110] hidden items-center justify-center p-6">
        <div class="nexus-card p-8 w-full max-w-sm">
            <h3 class="text-lg font-black font-kanit text-amber-500 mb-4">Set Goal</h3>
            <div class="space-y-4">
                <input type="text" id="goalInputName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ã‡∏∑‡πâ‡∏≠ iPhone, ‡∏ó‡∏£‡∏¥‡∏õ‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô..." class="glass-input">
                <input type="number" id="goalInputTarget" placeholder="‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)..." class="glass-input font-black">
                <div class="flex gap-3">
                    <button onclick="saveGoal()" class="flex-1 bg-amber-500 text-slate-950 p-3 rounded-xl font-black text-xs uppercase">Start Mission</button>
                    <button onclick="closeGoalSetup()" class="flex-1 bg-slate-800 text-white p-3 rounded-xl font-black text-xs uppercase">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Nexus Persistence Engine v43.0.0 ---
        const KEYS = {
            TX: 'nexus_v43_transactions',
            VAULT: 'nexus_v43_vault',
            GOAL: 'nexus_v43_goal'
        };

        let state = {
            transactions: [],
            vaultBalance: 0,
            goal: null
        };

        let dnaChart = null;

        // 1. Database Migration Protocol (‡∏´‡πâ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏≤‡∏¢)
        function migrate() {
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Key ‡πÄ‡∏Å‡πà‡∏≤ (v41, v42 ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πà‡∏≤‡πÜ)
            const legacyTx = localStorage.getItem('nexus_v41_transactions') || localStorage.getItem('nx41_transactions') || '[]';
            const legacyVault = localStorage.getItem('nexus_v41_vault') || localStorage.getItem('nx41_vault_balance') || '0';
            const legacyGoal = localStorage.getItem('nexus_v41_goal') || localStorage.getItem('nx41_goal_data') || 'null';

            // ‡∏ñ‡πâ‡∏≤ v43 ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏°‡∏≤‡∏™‡∏ß‡∏°
            if (!localStorage.getItem(KEYS.TX)) {
                localStorage.setItem(KEYS.TX, legacyTx);
                localStorage.setItem(KEYS.VAULT, legacyVault);
                localStorage.setItem(KEYS.GOAL, legacyGoal);
                console.log("v43 migration logic: History & Vault preserved.");
            }
        }

        function loadState() {
            state.transactions = JSON.parse(localStorage.getItem(KEYS.TX) || '[]');
            state.vaultBalance = parseFloat(localStorage.getItem(KEYS.VAULT) || '0');
            state.goal = JSON.parse(localStorage.getItem(KEYS.GOAL) || 'null');
        }

        function saveState() {
            localStorage.setItem(KEYS.TX, JSON.stringify(state.transactions));
            localStorage.setItem(KEYS.VAULT, state.vaultBalance.toString());
            localStorage.setItem(KEYS.GOAL, JSON.stringify(state.goal));
            updateChart();
        }

        // 2. Auto Purge (48H Cycle)
        function runPurge() {
            const now = Date.now();
            const LIMIT = 48 * 60 * 60 * 1000;
            
            const toPurge = state.transactions.filter(t => (now - new Date(t.date).getTime()) > LIMIT);
            if (toPurge.length > 0) {
                toPurge.forEach(t => {
                    if (t.type === 'income') state.vaultBalance += parseFloat(t.amount);
                    else state.vaultBalance -= parseFloat(t.amount);
                });
                state.transactions = state.transactions.filter(t => (now - new Date(t.date).getTime()) <= LIMIT);
                saveState();
                console.log(`[Auto-Purge] ${toPurge.length} old records consolidated into vault.`);
            }
        }

        // 3. Render Engine
        function render() {
            let currentFlow = 0;
            state.transactions.forEach(t => {
                currentFlow += (t.type === 'income' ? 1 : -1) * parseFloat(t.amount);
            });

            const netTotal = state.vaultBalance + currentFlow;
            document.getElementById('totalBalance').innerText = netTotal.toLocaleString(undefined, {minimumFractionDigits: 2});
            document.getElementById('vaultText').innerText = state.vaultBalance.toLocaleString();

            // History Stream
            const stream = document.getElementById('historyStream');
            if (state.transactions.length === 0) {
                stream.innerHTML = `<div class="text-center py-10 opacity-20 text-[10px] font-black uppercase italic tracking-widest">No Stream Data</div>`;
            } else {
                stream.innerHTML = state.transactions.slice().reverse().map((t, idx) => `
                    <div class="nexus-card p-4 flex justify-between items-center entry-anim group">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg flex items-center justify-center ${t.type === 'income' ? 'bg-emerald-500/10 text-emerald-500' : 'bg-rose-500/10 text-rose-500'}">
                                <span class="text-lg">${t.type === 'income' ? '‚Üô' : '‚Üó'}</span>
                            </div>
                            <div>
                                <p class="text-xs font-bold text-slate-200">${t.label}</p>
                                <p class="text-[8px] font-black text-slate-500 uppercase">${new Date(t.date).toLocaleString('th-TH')}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <p class="font-kanit font-black text-sm ${t.type === 'income' ? 'text-emerald-400' : 'text-rose-400'}">
                                ${t.type === 'income' ? '+' : '-'} ${parseFloat(t.amount).toLocaleString()}
                            </p>
                            <button onclick="deleteTx(${state.transactions.length - 1 - idx})" class="opacity-0 group-hover:opacity-100 p-2 text-rose-500/50 hover:text-rose-500 transition-all">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            // Goal
            const goalSec = document.getElementById('goalSection');
            if (state.goal) {
                goalSec.classList.remove('hidden');
                document.getElementById('goalName').innerText = state.goal.name;
                const perc = Math.min(100, (netTotal / state.goal.target) * 100);
                document.getElementById('goalProgress').style.width = perc + '%';
                document.getElementById('goalPercent').innerText = Math.floor(perc) + '%';
                document.getElementById('goalCurrent').innerText = '‡∏ø' + netTotal.toLocaleString();
                document.getElementById('goalTarget').innerText = '‡∏ø' + state.goal.target.toLocaleString();
                
                if (perc >= 100) triggerGoalComplete();
            } else {
                goalSec.classList.add('hidden');
            }
        }

        // 4. Chart Engine
        function updateChart() {
            const ctx = document.getElementById('dnaChart').getContext('2d');
            let income = 0;
            let expense = 0;
            state.transactions.forEach(t => {
                if (t.type === 'income') income += parseFloat(t.amount);
                else expense += parseFloat(t.amount);
            });

            if (dnaChart) dnaChart.destroy();

            dnaChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['In-Flow', 'Out-Flow'],
                    datasets: [{
                        data: [income || 1, expense || 0],
                        backgroundColor: ['#10b981', '#ef4444'],
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    cutout: '80%',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#64748b', font: { weight: 'bold', size: 10 } } }
                    }
                }
            });
        }

        // 5. Action Handlers
        document.getElementById('txForm').onsubmit = (e) => {
            e.preventDefault();
            const label = document.getElementById('txLabel').value;
            const amount = parseFloat(document.getElementById('txAmount').value);
            const type = document.getElementById('txType').value;

            state.transactions.push({ label, amount, type, date: new Date().toISOString() });
            saveState();
            render();
            e.target.reset();
        };

        function deleteTx(idx) {
            if (confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) {
                state.transactions.splice(idx, 1);
                saveState();
                render();
            }
        }

        function triggerGoalComplete() {
            // Logic ‡πÄ‡∏û‡∏∑‡πà‡∏≠ Reset Goal ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢ v41)
            setTimeout(() => {
                if (state.goal && confirm(`Mission [${state.goal.name}] Complete! Reset goal?`)) {
                    state.goal = null;
                    saveState();
                    render();
                }
            }, 500);
        }

        function saveGoal() {
            const name = document.getElementById('goalInputName').value;
            const target = parseFloat(document.getElementById('goalInputTarget').value);
            if (name && target > 0) {
                state.goal = { name, target };
                saveState();
                closeGoalSetup();
                toggleSettings();
                render();
            }
        }

        function toggleSettings() {
            const s = document.getElementById('settingsOverlay');
            s.classList.toggle('hidden');
            s.classList.toggle('flex');
        }

        function openGoalSetup() { document.getElementById('goalModal').classList.remove('hidden'); document.getElementById('goalModal').classList.add('flex'); }
        function closeGoalSetup() { document.getElementById('goalModal').classList.add('hidden'); document.getElementById('goalModal').classList.remove('flex'); }

        function confirmReset() {
            if (confirm("üö® WARNING: This will permanently purge all history and vault balance. Proceed?")) {
                localStorage.clear();
                location.reload();
            }
        }

        // Boot
        window.onload = () => {
            migrate();
            loadState();
            runPurge();
            render();
            updateChart();
            setInterval(runPurge, 3600000); // Check every hour
        };
    </script>
</body>
</html>
